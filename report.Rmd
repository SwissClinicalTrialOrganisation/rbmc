---
output: pdf_document
classoption: a4paper
params:
  input: NA
  texttab: NA
header-includes:
  - \usepackage[T1]{fontenc}
  - \usepackage{lastpage}
  - \usepackage{fancyhdr}
  - \usepackage{float}
  - \usepackage{graphicx}
  - \usepackage{moresize}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage[default]{comfortaa}
  - \usepackage[T1]{fontenc}
  - \pagestyle{fancy}
---

```{r, echo = FALSE}
options(Encoding="UTF-8")
library(gt)
library(dplyr)
library(magrittr)
library(tidyr)
```


<!-- Document configuration -->

<!-- path to images -->
<!-- \graphicspath{ {./`r params$dir`} } -->

<!-- table interline -->
\renewcommand{\arraystretch}{1}
\renewcommand{\baselinestretch}{1.5}

<!-- table margins -->
<!-- \setlength{\LTleft}{0pt minus 1000pt} -->
<!-- \setlength{\LTright}{0pt minus 1000pt} -->

<!-- header/footer -->
\fancyhead[R]{Report date: `r Sys.time()`}
\cfoot[\fancyplain{}{}]{\fancyplain{}{}}
\rfoot{\thepage\ of \pageref{LastPage}}
\lfoot{Data entered by `r params$input$au` on `r Sys.Date()`}
\thispagestyle{fancy}

<!-- Report content -->

<!-- Title -->
\begin{minipage}{0.75\textwidth}
  \vspace*{1cm}
  \section{\huge{Risk Based Monitoring Score}}
  \vspace*{0.5cm}
  \subsection{Project: `r params$input$studyname`}
\end{minipage}
\hfill
\begin{minipage}{0.2\textwidth}
  \begin{figure}[H]
    \includegraphics{logo.png}
  \end{figure}
\end{minipage}

<!-- Table -->
\vspace{1cm}
\scriptsize


```{r, echo = FALSE}
inputs <- reactiveValuesToList(params$input)
inputs <- inputs[!names(inputs) == "sidebarItemExpanded"]
tmp <- as.data.frame(inputs) %>%
  mutate(across(everything(), as.character)) %>%
  pivot_longer(cols = everything(), 
               names_to = c("i", "j"), 
               names_pattern = "(.*)_(imp|occ|det|tx|appl)$") %>%
  filter(!is.na(i)) %>%
  pivot_wider(id_cols = "i", names_from = "j", values_from = "value") %>%
  mutate(across(c("imp", "occ", "appl", "det"), as.numeric),
         score = imp*occ*det,
         appl = case_when(grepl("other", .data$i) ~ 1,
                          TRUE ~ appl))

# browser()
tmp2 <- params$texttab %>%
  full_join(tmp, by = c("ref" = "i")) %>%
  filter(appl > 0)

if("tx" %in% names(tmp)) tmp2 <- tmp2 %>% 
  mutate(Risk = case_when(!is.na(Risk) ~ Risk,
                          is.na(Risk) ~ tx))

tmp2 %>%
  mutate(category = case_when(!is.na(category) ~ category,
                              is.na(category) ~ "VII. Other Risks")) %>%
  select(category, Risk, imp, occ, det, score) %>%
  rename(Impact = imp,
         Occurance = occ,
         Detectability = det,
         Score = score) %>% 
  group_by(category) %>%
  gt() %>%
  data_color(columns = "Score",
             colors = scales::col_bin(palette = c("green", "orange", "red"),
                                      bins = c(1, 3, 9, 27)),
             apply_to = "text")

# tt
```


\pagebreak
